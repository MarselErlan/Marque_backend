# ğŸ—ï¸ Authentication & Session Management Architecture

> Visual guide showing how everything works together

---

## ğŸ¯ Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER'S PHONE                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    REACT NATIVE APP                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  ğŸ“± UI Components:                                       â”‚  â”‚
â”‚  â”‚     - LoginScreen                                        â”‚  â”‚
â”‚  â”‚     - CartScreen                                         â”‚  â”‚
â”‚  â”‚     - WishlistScreen                                     â”‚  â”‚
â”‚  â”‚     - ProductScreen                                      â”‚  â”‚
â”‚  â”‚     - OrdersScreen                                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  ğŸ’¾ AsyncStorage:                                        â”‚  â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚  â”‚     â”‚  access_token: "eyJhbGci..."            â”‚       â”‚  â”‚
â”‚  â”‚     â”‚  (Contains: user_id, market, exp)       â”‚       â”‚  â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  ğŸ”§ Services:                                            â”‚  â”‚
â”‚  â”‚     - authService.js (login/logout)                      â”‚  â”‚
â”‚  â”‚     - cartService.js (cart operations)                   â”‚  â”‚
â”‚  â”‚     - wishlistService.js (wishlist operations)           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTPS Request
                              â”‚ Authorization: Bearer {token}
                              â”‚ X-Market: us
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FASTAPI BACKEND                            â”‚
â”‚                    (Railway Deployment)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   API Endpoints                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  ğŸ” Auth:                                                â”‚  â”‚
â”‚  â”‚     POST /auth/send-verification                         â”‚  â”‚
â”‚  â”‚     POST /auth/verify-code                               â”‚  â”‚
â”‚  â”‚     POST /auth/logout                                    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  ğŸ›’ Cart:                                                â”‚  â”‚
â”‚  â”‚     GET  /cart                                           â”‚  â”‚
â”‚  â”‚     POST /cart/items                                     â”‚  â”‚
â”‚  â”‚     PUT  /cart/items/{id}                                â”‚  â”‚
â”‚  â”‚     DELETE /cart/items/{id}                              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â¤ï¸  Wishlist:                                           â”‚  â”‚
â”‚  â”‚     GET  /wishlist                                       â”‚  â”‚
â”‚  â”‚     POST /wishlist/items                                 â”‚  â”‚
â”‚  â”‚     DELETE /wishlist/items/{id}                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  ğŸ“¦ Orders:                                              â”‚  â”‚
â”‚  â”‚     GET  /profile/orders                                 â”‚  â”‚
â”‚  â”‚     GET  /profile/orders/{id}                            â”‚  â”‚
â”‚  â”‚     POST /profile/orders/{id}/cancel                     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚             Dependency: get_current_user_from_token()     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  1. Extract token from Authorization header             â”‚  â”‚
â”‚  â”‚  2. Decode JWT:                                          â”‚  â”‚
â”‚  â”‚     {                                                    â”‚  â”‚
â”‚  â”‚       "user_id": 19,                                    â”‚  â”‚
â”‚  â”‚       "market": "us",                                   â”‚  â”‚
â”‚  â”‚       "exp": 1729703400                                 â”‚  â”‚
â”‚  â”‚     }                                                    â”‚  â”‚
â”‚  â”‚  3. Check expiration                                     â”‚  â”‚
â”‚  â”‚  4. Query database: SELECT * FROM users WHERE id = 19   â”‚  â”‚
â”‚  â”‚  5. Check is_active = true                              â”‚  â”‚
â”‚  â”‚  6. Return user info                                     â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ SQL Queries
                              â”‚ (using user_id = 19)
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   POSTGRESQL DATABASE                           â”‚
â”‚                    (Railway Deployment)                         â”‚
â”‚                                                                 â”‚
â”‚  ğŸ“Š Tables:                                                     â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ users                                                   â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ id: 19                                                  â”‚  â”‚
â”‚  â”‚ phone: +13128059851                                    â”‚  â”‚
â”‚  â”‚ is_active: true      â† Controls session validity! ğŸ”‘   â”‚  â”‚
â”‚  â”‚ is_verified: true                                      â”‚  â”‚
â”‚  â”‚ market: us                                             â”‚  â”‚
â”‚  â”‚ last_login: 2025-10-24 12:30:00                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â”‚ Foreign Key                      â”‚
â”‚                              â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ carts                                                    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ id: 5                                                    â”‚  â”‚
â”‚  â”‚ user_id: 19  â† Links cart to user! ğŸ”—                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚ Foreign Key                      â”‚
â”‚                              â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ cart_items                                               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ id: 101                                                  â”‚  â”‚
â”‚  â”‚ cart_id: 5  â† Links to cart above ğŸ”—                    â”‚  â”‚
â”‚  â”‚ sku_id: 42                                              â”‚  â”‚
â”‚  â”‚ quantity: 2                                             â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚  â”‚
â”‚  â”‚ id: 102                                                  â”‚  â”‚
â”‚  â”‚ cart_id: 5                                              â”‚  â”‚
â”‚  â”‚ sku_id: 88                                              â”‚  â”‚
â”‚  â”‚ quantity: 1                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ wishlists                                               â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ id: 8                                                   â”‚  â”‚
â”‚  â”‚ user_id: 19  â† Links wishlist to user! ğŸ”—              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚ Foreign Key                      â”‚
â”‚                              â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ wishlist_items                                           â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ id: 201                                                  â”‚  â”‚
â”‚  â”‚ wishlist_id: 8  â† Links to wishlist above ğŸ”—           â”‚  â”‚
â”‚  â”‚ product_id: 15                                          â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚  â”‚
â”‚  â”‚ id: 202                                                  â”‚  â”‚
â”‚  â”‚ wishlist_id: 8                                          â”‚  â”‚
â”‚  â”‚ product_id: 27                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ orders                                                  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ id: 1001                                                â”‚  â”‚
â”‚  â”‚ order_number: #1001                                    â”‚  â”‚
â”‚  â”‚ user_id: 19  â† Links order to user! ğŸ”—                 â”‚  â”‚
â”‚  â”‚ status: delivered                                      â”‚  â”‚
â”‚  â”‚ total_amount: 5999.99                                  â”‚  â”‚
â”‚  â”‚ order_date: 2025-10-20                                 â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚  â”‚
â”‚  â”‚ id: 1002                                                â”‚  â”‚
â”‚  â”‚ order_number: #1002                                    â”‚  â”‚
â”‚  â”‚ user_id: 19                                            â”‚  â”‚
â”‚  â”‚ status: processing                                     â”‚  â”‚
â”‚  â”‚ total_amount: 2499.99                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚ Foreign Key                      â”‚
â”‚                              â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ order_items                                              â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ id: 5001                                                 â”‚  â”‚
â”‚  â”‚ order_id: 1001                                          â”‚  â”‚
â”‚  â”‚ sku_id: 42                                              â”‚  â”‚
â”‚  â”‚ quantity: 1                                             â”‚  â”‚
â”‚  â”‚ unit_price: 5999.99                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Complete User Flow: Add to Cart

```
Step 1: User clicks "Add to Cart"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      React Native App               â”‚
â”‚                                     â”‚
â”‚  User clicks: Add to Cart           â”‚
â”‚  Button: sku_id = 42, quantity = 2 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ JavaScript:
               â”‚ await cartService.addToCart(42, 2)
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      API Service                    â”‚
â”‚                                     â”‚
â”‚  1. Get token from AsyncStorage     â”‚
â”‚     token = "eyJhbGci..."          â”‚
â”‚                                     â”‚
â”‚  2. Make HTTP request:              â”‚
â”‚     POST /cart/items                â”‚
â”‚     Headers:                        â”‚
â”‚       Authorization: Bearer {token} â”‚
â”‚       X-Market: us                  â”‚
â”‚     Body:                           â”‚
â”‚       {sku_id: 42, quantity: 2}    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ HTTPS Request
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Backend API Endpoint           â”‚
â”‚                                     â”‚
â”‚  @router.post("/cart/items")        â”‚
â”‚  def add_to_cart(                   â”‚
â”‚    request: AddToCartRequest,       â”‚
â”‚    current_user = Depends(...)      â”‚
â”‚  )                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Decode JWT Token
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  get_current_user_from_token()      â”‚
â”‚                                     â”‚
â”‚  1. Extract token:                  â”‚
â”‚     "eyJhbGci..."                  â”‚
â”‚                                     â”‚
â”‚  2. Decode JWT:                     â”‚
â”‚     payload = {                     â”‚
â”‚       user_id: 19,                 â”‚
â”‚       market: "us",                â”‚
â”‚       exp: 1729703400              â”‚
â”‚     }                               â”‚
â”‚                                     â”‚
â”‚  3. Check expiration:               â”‚
â”‚     if now() > exp: REJECT âŒ      â”‚
â”‚                                     â”‚
â”‚  4. Query database:                 â”‚
â”‚     user = SELECT * FROM users     â”‚
â”‚            WHERE id = 19           â”‚
â”‚                                     â”‚
â”‚  5. Check if active:                â”‚
â”‚     if not user.is_active: REJECT âŒâ”‚
â”‚                                     â”‚
â”‚  6. Return user:                    â”‚
â”‚     return {user_id: 19, ...}      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ user_id = 19 âœ…
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  add_to_cart() continues...         â”‚
â”‚                                     â”‚
â”‚  user_id = current_user.user_id    â”‚
â”‚  # user_id = 19                    â”‚
â”‚                                     â”‚
â”‚  1. Find or create cart:            â”‚
â”‚     cart = SELECT * FROM carts     â”‚
â”‚            WHERE user_id = 19      â”‚
â”‚                                     â”‚
â”‚     if not cart:                    â”‚
â”‚       INSERT INTO carts            â”‚
â”‚       (user_id) VALUES (19)       â”‚
â”‚       cart_id = 5                  â”‚
â”‚                                     â”‚
â”‚  2. Add item to cart:               â”‚
â”‚     INSERT INTO cart_items         â”‚
â”‚     (cart_id, sku_id, quantity)   â”‚
â”‚     VALUES (5, 42, 2)              â”‚
â”‚                                     â”‚
â”‚  3. Return response                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ Response: {cart data}
               â”‚
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      React Native App               â”‚
â”‚                                     â”‚
â”‚  Show: "Added to cart!" âœ…         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸšª Logout and Login Flow

```
LOGOUT:
â”€â”€â”€â”€â”€â”€â”€

User clicks "Logout"
  â†“
Frontend: authService.logout()
  â†“
Backend: POST /auth/logout
  â†“
Database: UPDATE users
          SET is_active = false
          WHERE id = 19
  â†“
Frontend: AsyncStorage.removeItem('access_token')
  â†“
âœ… User logged out
   - Token deleted from phone
   - is_active = false (token won't work even if intercepted)
   - Cart data STILL IN DATABASE (user_id = 19)


LOGIN AGAIN:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

User enters phone + code
  â†“
Backend: POST /auth/verify-code
  â†“
Backend verifies code with Twilio
  â†“
Database: UPDATE users
          SET is_active = true,
              last_login = NOW()
          WHERE phone = '+13128059851'
  â†“
Backend finds user_id = 19 (SAME USER!)
  â†“
Backend creates NEW JWT token:
  {
    user_id: 19,     â† SAME user_id!
    market: "us",
    exp: (30 min from now)
  }
  â†“
Frontend: AsyncStorage.setItem('access_token', NEW_TOKEN)
  â†“
âœ… User logged in
   - New token stored
   - is_active = true
   - Same user_id = 19


CHECK CART:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

User opens cart
  â†“
Frontend: await cartService.getCart()
  â†“
Frontend sends: Authorization: Bearer {NEW_TOKEN}
  â†“
Backend decodes NEW_TOKEN:
  â†’ user_id = 19 (SAME user_id!)
  â†“
Backend queries:
  SELECT * FROM cart_items
  WHERE cart_id IN (
    SELECT id FROM carts WHERE user_id = 19
  )
  â†“
Returns: Same items as before logout!
  - sku_id: 42, quantity: 2
  â†“
âœ… CART PERSISTED! ğŸ‰
```

---

## ğŸ”‘ Key Concepts Visualized

### 1. JWT Token = Temporary Key ğŸ—ï¸

```
JWT Token Lifecycle:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[Created]           [Expires]
   â”‚                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€30minâ”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                   â”‚
   â†“                   â†“
 Valid              Invalid
 (Works)            (Must re-login)

BUT: User data persists in database!

Database:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
users (id: 19) â†â”€â”¬â”€ carts
                 â”œâ”€ wishlists
                 â””â”€ orders

This NEVER expires! âœ…
```

### 2. user_id = Permanent Identity ğŸ†”

```
Different Tokens, Same User:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Login 1 (Oct 1):
  Token: eyJA...xyz1
  Contains: {user_id: 19, exp: ...}
                     â†“
Login 2 (Oct 15):         â”Œâ”€â”€â”€â”€â”€â”
  Token: eyJB...abc2   â”€â”€â”€â†’â”‚ 19 â”‚â† Always same user_id!
  Contains: {user_id: 19}  â””â”€â”€â”€â”€â”€â”˜
                     â†“          â†‘
Login 3 (Oct 30):               â”‚
  Token: eyJC...def3   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Contains: {user_id: 19}

All tokens â†’ Same database records!
```

### 3. Foreign Keys = Data Linkage ğŸ”—

```
Database Relationships:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

users.id = 19
    â”‚
    â”œâ”€â”€ carts.user_id = 19
    â”‚       â”‚
    â”‚       â””â”€â”€ cart_items.cart_id = 5
    â”‚              â”œâ”€ item 1
    â”‚              â””â”€ item 2
    â”‚
    â”œâ”€â”€ wishlists.user_id = 19
    â”‚       â”‚
    â”‚       â””â”€â”€ wishlist_items.wishlist_id = 8
    â”‚              â”œâ”€ item 1
    â”‚              â””â”€ item 2
    â”‚
    â””â”€â”€ orders.user_id = 19
            â”œâ”€ order #1001
            â””â”€ order #1002

As long as user_id exists:
  âœ… All data accessible
  âœ… Survives logout
  âœ… Survives token expiration
  âœ… Syncs across devices
```

---

## ğŸ¯ Summary

### What's Stored Where:

| Data           | Storage                      | Lifetime             |
| -------------- | ---------------------------- | -------------------- |
| JWT Token      | Frontend (AsyncStorage)      | 30 minutes           |
| user_id        | Database + JWT               | Forever              |
| Cart Items     | Database (linked to user_id) | Forever              |
| Wishlist Items | Database (linked to user_id) | Forever              |
| Orders         | Database (linked to user_id) | Forever              |
| is_active flag | Database                     | Controlled by logout |

### How It Works:

1. **Login** â†’ Generate JWT with `user_id` â†’ Store in AsyncStorage
2. **Every Request** â†’ Send JWT â†’ Decode to get `user_id` â†’ Query database
3. **Add to Cart** â†’ Save in database linked to `user_id` âœ…
4. **Logout** â†’ Set `is_active = false` â†’ Delete token from AsyncStorage
5. **Login Again** â†’ New JWT with same `user_id` â†’ Access same cart âœ…

### Why It's Secure:

1. **JWT expires** (30 min) â†’ Must re-login regularly
2. **is_active flag** â†’ Logout invalidates token immediately
3. **HTTPS** â†’ Token encrypted in transit
4. **No token in database** â†’ Can't be stolen from database breach
5. **Foreign keys** â†’ Users can only access their own data

---

## âœ… You're All Set!

Your architecture is **production-ready** and follows **industry best practices**! ğŸš€

See:

- [`SESSION_MANAGEMENT_EXPLAINED.md`](./SESSION_MANAGEMENT_EXPLAINED.md) - Detailed explanation
- [`SESSION_QUICK_REFERENCE.md`](./SESSION_QUICK_REFERENCE.md) - Quick reference
- [`FRONTEND_CART_EXAMPLE.md`](./FRONTEND_CART_EXAMPLE.md) - Frontend code examples
